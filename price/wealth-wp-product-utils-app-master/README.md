# WPC DB Utils App

This App provides 3 functions:

- load  - import full data set from Oracle DB to MongoDB
- sync  - import updated data from Oracle DB to MongoDB, since last import
- watch - import updated data from Oracle DB to MongoDB periodically

## Design

Basically, the data synchronize is built on top of Oracle DB triggers.

### Oracle DB Side

`DATA_SYNC_WATCH_ID_SEQ` Sequence 

Provide a sequence for the ID field in table `DATA_SYNC_WATCH`.

`DATA_SYNC_WATCH` Table

A simple table to store row change event.

`Triggers` per table

A trigger is created for each table, it will run on any row change like INSERT, UPDATE, DELETE, and then register the 
event with ROW_ID to table `DATA_SYNC_WATCH`.

See `script/data_sync_watch_db_change.sql` for details, which are expected to be created in the target OracleDB.

### MongoDB Side

`data_sync_log` collection is created to record synchronize activity, which include `startId`, `endId` in the table 
`DATA_SYNC_WATCH`, every time before synchronize, the latest `endId` will be retrieved, and only those event records with `DATA_SYNC_WATCH.ID`
are greater than this will be handled in next round.  

### Java App (This App)

The app has 3 working mode, `load`, `sync` and `watch`.

- `load`: Perform a full data load from OracleDB to MongoDB, corresponding MongoDB collections should be empty, otherwise it will be skipped.
- `sync`: Perform one time synchronize, since the last `endId`, 1000 events per time maximum. 
- `watch`: Perform synchronization periodically, every time will start from the last `endId`, 1000 events per time maximum.

## Build and Deploy

```bash
mvn clean install
```

Copy the jar from `target/wpc-db-utils-app-<version>.jar` to anywhere you would like to deploy and run.

## Run

OracleDB and MongoDB connection information need to be config, a simple approach is to config them in an `application.yml` 
file, and place the file alongside with jar, and then

```bash
java -jar wpc-db-utils-app-<version>.jar
# with JAVA_OPTS
-Duser.timezone=GMT+0
-Djavax.net.ssl.trustStoreType=JKS
-Djavax.net.ssl.trustStore=src/main/resources/rds-truststore.jks
-Djavax.net.ssl.trustStorePassword=wealthit
-Dadmin.secret.key={cipher}6b7aa616ff70df461e44eca2792e0d5c28595ac3440c5e4bc8b36339c68fd629
``` 

And then access the dashboard, eg. `http://localhost:8088/` to perform operations. 

### Secret Key

A `Secret Key` should be specified when doing operations. 

This key should be generated by the `Spring Cloud Config - encryption` function under corresponding [devtool](https://devtool-demo.wealth-platform-uk.euw1.dev.aws.cloud.dummy/), and put as a JAVA_OPTS when deploy / run. 

```bash
# encrypted form
-Dadmin.secret.key={cipher}6b7aa616ff70df461e44eca2792e0d5c28595ac3440c5e4bc8b36339c68fd629
# or plain text form in dev env
-Dadmin.secret.key=xxxxxx
```

Example application.yml 
```yaml
spring:
  datasource:
    url: jdbc:oracle:thin:@(DESCRIPTION =(ADDRESS_LIST =(ADDRESS = (PROTOCOL = TCP)(HOST = hkg3pl0038n3-scan.p2g.netd.hk.dummy)(PORT = 2000)))(CONNECT_DATA = (SERVER = DEDICATED) (SERVICE_NAME = AP2GWPC.hk.dummy)(FAILOVER_MODE =(TYPE = SELECT)(METHOD = BASIC))))
    username: WPCGLASP1
    password: <password>
  data:
    mongodb:
      uri: mongodb://localhost:27017/WPC_POC

wpc:
  mongo-database-name: WPC_POC
  data-sync-interval: 60   # 60 seconds by default
```

Use any other spring-boot support approach to feed config should be supported.

## Another Option: Database Change Notification

`Database Change Notification` is a similar mechanism for synchronize data change from OracleDB, several features below 
makes it look like idealism solution,

- It supports to run a listener as a java program or PL/SQL procedure, especially it needs only ONE PL/SQL procedure (but not a bunch of triggers), to register
all the change events
- This operation is post transaction submit (a trigger runs in the transaction session)

But this was finally abandon after a trial, most important reason behind is if a transaction update too many records, it won't
be able to get the ROWID but ALL_ROWS. 

> The ROWID notifications are hierarchically summarized. If enough memory is not available on the server side to hold ROWIDs, then the notification might be rolled up into a FULL-TABLE-NOTIFICATION (a special flag in the notification descriptor is reserved for this purpose). When such a notification is received, the application must conservatively assume that the entire table (that is, all rows) may have been modified. ROWIDs are not part of such a notification. ROWIDs may be rolled-up if the total shared memory consumption due to ROWIDs is too large (exceeds 1% of the dynamic shared pool size), OR if too many rows were modified in a single registered object within a transaction (more than 80 approximately) OR if the total length of the logical ROWIDs of modified rows for an IOT is too large (exceeds. 1800 bytes approximately.).


Validation error sample:
```json
[
  {
    "subject": "TB_PROD_USER_DEFIN_EXT_FIELD",
    "message": "duplicate field definition",
    "data": {
      "1": {
        "FIELD_CDE": "exoMIPMinAmt",
        "FIELD_DATA_TYPE_TEXT": "Decimal"
      },
      "2": {
        "FIELD_CDE": "exoMIPMinAmt",
        "FIELD_DATA_TYPE_TEXT": "Char"
      }
    }
  }
]
```

## Reference
- [Database JDBC Developer's Guide - Database Change Notification](https://docs.oracle.com/cd/E11882_01/java.112/e16548/dbchgnf.htm#JJDBC28820)
- [Developing Applications with Database Change Notification](https://docs.oracle.com/cd/B19306_01/B14251_01/adfns_dcn.htm)
- [Spring Properties File Outside jar](https://www.baeldung.com/spring-properties-file-outside-jar)
- [Spring Task Scheduler](https://www.baeldung.com/spring-task-scheduler)
- [ROWID Pseudocolumn](https://docs.oracle.com/cd/B19306_01/server.102/b14200/pseudocolumns008.htm#:~:text=Usually%2C%20a%20rowid%20value%20uniquely,the%20datatype%20ROWID%20or%20UROWID%20.)