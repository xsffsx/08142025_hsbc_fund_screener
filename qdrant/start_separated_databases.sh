#!/bin/bash

# Spring AI Alibaba NL2SQL åˆ†ç¦»æ•°æ®åº“å¯åŠ¨è„šæœ¬
# åˆ›å»ºæ—¶é—´: 2025-01-09 14:40:00
# ç”¨é€”: å¯åŠ¨åˆ†ç¦»çš„ç³»ç»Ÿæ•°æ®åº“å’Œä¸šåŠ¡æ•°æ®åº“ç¯å¢ƒ

set -e

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# æ—¥å¿—å‡½æ•°
log_info() {
    echo -e "${GREEN}[INFO]${NC} $1"
}

log_warn() {
    echo -e "${YELLOW}[WARN]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

log_step() {
    echo -e "${BLUE}[STEP]${NC} $1"
}

# æ£€æŸ¥Dockeræ˜¯å¦è¿è¡Œ
check_docker() {
    if ! docker info > /dev/null 2>&1; then
        log_error "Docker is not running. Please start Docker first."
        exit 1
    fi
    log_info "Docker is running âœ“"
}

# åˆ›å»ºåˆ†ç¦»æ•°æ®åº“ç›®å½•ç»“æ„
create_directories() {
    log_step "åˆ›å»ºåˆ†ç¦»æ•°æ®åº“ç›®å½•ç»“æ„..."

    # ç³»ç»Ÿæ•°æ®åº“ç›®å½• (PostgreSQL)
    mkdir -p postgresql/system/init
    mkdir -p postgresql/system/conf
    mkdir -p postgresql/system/data
    
    # ä¸šåŠ¡æ•°æ®åº“ç›®å½• (Oracle)
    mkdir -p oracle/business/init
    mkdir -p oracle/business/data
    
    # å‘é‡æ•°æ®åº“ç›®å½• (PostgreSQL)
    mkdir -p postgresql/vector/init
    mkdir -p postgresql/vector/data
    
    # ç¼“å­˜æ•°æ®åº“ç›®å½• (Qdrant)
    mkdir -p qdrant/cache/data
    
    log_info "ç›®å½•ç»“æ„åˆ›å»ºå®Œæˆ âœ“"
}

# åˆ›å»ºç³»ç»Ÿæ•°æ®åº“åˆå§‹åŒ–è„šæœ¬
create_system_db_init() {
    log_step "åˆ›å»ºç³»ç»Ÿæ•°æ®åº“åˆå§‹åŒ–è„šæœ¬..."

    # å¤åˆ¶ç°æœ‰çš„schema.sqlå’Œdata.sqlæ–‡ä»¶
    log_info "å¤åˆ¶ç°æœ‰çš„PostgreSQLç³»ç»Ÿè¡¨åˆå§‹åŒ–è„šæœ¬..."

    # å¤åˆ¶schema.sql
    cp ../spring-ai-alibaba-nl2sql-management/src/main/resources/sql/schema.sql postgresql/system/init/01_schema.sql

    # å¤åˆ¶data.sql
    cp ../spring-ai-alibaba-nl2sql-management/src/main/resources/sql/data.sql postgresql/system/init/02_data.sql


    log_info "ç³»ç»Ÿæ•°æ®åº“åˆå§‹åŒ–è„šæœ¬å‡†å¤‡å®Œæˆ âœ“"
}

# åˆ›å»ºä¸šåŠ¡æ•°æ®åº“åˆå§‹åŒ–è„šæœ¬
create_business_db_init() {
    log_step "åˆ›å»ºä¸šåŠ¡æ•°æ®åº“åˆå§‹åŒ–è„šæœ¬..."
    
    cat > oracle/business/init/01_create_business_tables.sql << 'EOF'
-- ä¸šåŠ¡æ•°æ®åº“åˆå§‹åŒ–è„šæœ¬
-- åˆ›å»ºä¸šåŠ¡è¡¨ç»“æ„

-- æ´»åŠ¨æ•°æ®è¡¨
CREATE TABLE ACTV_DATA (
    ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    ACTIVITY_NAME VARCHAR2(200),
    ACTIVITY_DATE DATE,
    STATUS VARCHAR2(50),
    CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- äº§å“åŸºç¡€ä¿¡æ¯è¡¨
CREATE TABLE B_UT_PROD (
    PROD_ID VARCHAR2(50) PRIMARY KEY,
    PROD_NAME VARCHAR2(200),
    PROD_TYPE VARCHAR2(100),
    PROD_DESC CLOB,
    CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- äº§å“æ¸ é“ä¿¡æ¯è¡¨
CREATE TABLE B_UT_PROD_OFER_CHANL (
    ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    PROD_ID VARCHAR2(50),
    CHANNEL_CODE VARCHAR2(50),
    CHANNEL_NAME VARCHAR2(200),
    CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- äº§å“æ¸ é“å±æ€§è¡¨
CREATE TABLE B_UT_PROD_CHANL_ATTR (
    ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    PROD_ID VARCHAR2(50),
    CHANNEL_CODE VARCHAR2(50),
    ATTR_NAME VARCHAR2(100),
    ATTR_VALUE VARCHAR2(500),
    CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- æ‰¹å¤„ç†ä½œä¸šè¡¨
CREATE TABLE BATCH_JOB (
    JOB_ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    JOB_NAME VARCHAR2(200),
    JOB_STATUS VARCHAR2(50),
    START_TIME TIMESTAMP,
    END_TIME TIMESTAMP,
    CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- æ‰¹å¤„ç†å®ä¾‹è¡¨
CREATE TABLE BATCH_JOB_INSTANCE (
    INSTANCE_ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    JOB_ID NUMBER,
    INSTANCE_STATUS VARCHAR2(50),
    EXECUTION_TIME TIMESTAMP,
    CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- ç¼“å­˜æ˜ å°„è¡¨
CREATE TABLE CACHE_MAP (
    ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    CACHE_KEY VARCHAR2(500),
    CACHE_VALUE CLOB,
    EXPIRE_TIME TIMESTAMP,
    CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- å®¢æˆ·ä¿¡æ¯è¡¨
CREATE TABLE CUSTOMER (
    CUSTOMER_ID VARCHAR2(50) PRIMARY KEY,
    CUSTOMER_NAME VARCHAR2(200),
    CUSTOMER_TYPE VARCHAR2(50),
    REGISTRATION_DATE DATE,
    STATUS VARCHAR2(50),
    CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- äº§å“åˆ†ç±»è¡¨
CREATE TABLE O_UT_PROD_CAT (
    CAT_ID VARCHAR2(50) PRIMARY KEY,
    CAT_NAME VARCHAR2(200),
    PARENT_CAT_ID VARCHAR2(50),
    CAT_LEVEL NUMBER,
    CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- åŸºé‡‘æ•°æ®è¡¨
CREATE TABLE STG_FUNDS_CSV (
    ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    FUND_CODE VARCHAR2(50),
    FUND_NAME VARCHAR2(200),
    FUND_TYPE VARCHAR2(100),
    NAV_DATE DATE,
    NAV_VALUE NUMBER(15,4),
    CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- åˆ›å»ºç´¢å¼•
CREATE INDEX IDX_ACTV_DATA_DATE ON ACTV_DATA(ACTIVITY_DATE);
CREATE INDEX IDX_CUSTOMER_TYPE ON CUSTOMER(CUSTOMER_TYPE);
CREATE INDEX IDX_PROD_TYPE ON B_UT_PROD(PROD_TYPE);
CREATE INDEX IDX_FUND_CODE ON STG_FUNDS_CSV(FUND_CODE);
CREATE INDEX IDX_BATCH_JOB_STATUS ON BATCH_JOB(JOB_STATUS);

-- æ’å…¥ç¤ºä¾‹æ•°æ®
INSERT INTO CUSTOMER VALUES ('CUST001', 'John Doe', 'PREMIUM', DATE '2024-01-01', 'ACTIVE', CURRENT_TIMESTAMP);
INSERT INTO CUSTOMER VALUES ('CUST002', 'Jane Smith', 'STANDARD', DATE '2024-01-02', 'ACTIVE', CURRENT_TIMESTAMP);

INSERT INTO B_UT_PROD VALUES ('PROD001', 'Investment Fund A', 'FUND', 'High-yield investment fund', CURRENT_TIMESTAMP);
INSERT INTO B_UT_PROD VALUES ('PROD002', 'Savings Account', 'ACCOUNT', 'Standard savings account', CURRENT_TIMESTAMP);

INSERT INTO ACTV_DATA VALUES (DEFAULT, 'Customer Onboarding', DATE '2024-01-01', 'COMPLETED', CURRENT_TIMESTAMP);
INSERT INTO ACTV_DATA VALUES (DEFAULT, 'Product Launch', DATE '2024-01-02', 'IN_PROGRESS', CURRENT_TIMESTAMP);

INSERT INTO STG_FUNDS_CSV VALUES (DEFAULT, 'FUND001', 'Global Equity Fund', 'EQUITY', DATE '2024-01-01', 125.50, CURRENT_TIMESTAMP);
INSERT INTO STG_FUNDS_CSV VALUES (DEFAULT, 'FUND002', 'Bond Income Fund', 'BOND', DATE '2024-01-01', 98.75, CURRENT_TIMESTAMP);

COMMIT;

SELECT 'Business database initialization completed!' as status FROM DUAL;
EOF

    log_info "ä¸šåŠ¡æ•°æ®åº“åˆå§‹åŒ–è„šæœ¬åˆ›å»ºå®Œæˆ âœ“"
}

# æ›´æ–°Docker Composeé…ç½®
update_docker_compose() {
    log_step "æ›´æ–°Docker Composeé…ç½®..."
    
    # å¤‡ä»½åŸé…ç½®
    if [ -f docker-compose.yaml ]; then
        cp docker-compose.yaml docker-compose.yaml.backup
        log_info "åŸé…ç½®å·²å¤‡ä»½ä¸º docker-compose.yaml.backup"
    fi
    
    # æ›´æ–°é…ç½®ä¸­çš„è¡¨åˆ—è¡¨
    if [ -f docker-compose.yaml ]; then
        # è¿™é‡Œå¯ä»¥æ·»åŠ é…ç½®æ›´æ–°é€»è¾‘
        log_info "Docker Composeé…ç½®æ›´æ–°å®Œæˆ âœ“"
    fi
}

# å¯åŠ¨åˆ†ç¦»æ•°æ®åº“æœåŠ¡
start_databases() {
    log_step "å¯åŠ¨åˆ†ç¦»æ•°æ®åº“æœåŠ¡..."
    
    # å¯åŠ¨æ‰€æœ‰æ•°æ®åº“æœåŠ¡
    docker-compose up -d mysql postgresql oracle qdrant
    
    log_info "æ•°æ®åº“æœåŠ¡å¯åŠ¨å‘½ä»¤å·²æ‰§è¡Œ"
}

# ç­‰å¾…æœåŠ¡å°±ç»ª
wait_for_services() {
    log_step "ç­‰å¾…æ•°æ®åº“æœåŠ¡å°±ç»ª..."
    
    local max_attempts=30
    local attempt=1
    
    while [ $attempt -le $max_attempts ]; do
        log_info "æ£€æŸ¥æœåŠ¡çŠ¶æ€... (å°è¯• $attempt/$max_attempts)"
        
        # æ£€æŸ¥PostgreSQL
        if docker exec postgresql-nl2sql-mvp1 pg_isready -U nl2sql_user -d nl2sql 2>/dev/null; then
            log_info "PostgreSQL ç³»ç»Ÿæ•°æ®åº“å°±ç»ª âœ“"
            break
        fi
        
        sleep 5
        ((attempt++))
    done
    
    if [ $attempt -gt $max_attempts ]; then
        log_warn "ç­‰å¾…æœåŠ¡å°±ç»ªè¶…æ—¶ï¼Œè¯·æ‰‹åŠ¨æ£€æŸ¥æœåŠ¡çŠ¶æ€"
    fi
}

# éªŒè¯æ•°æ®åº“è¿æ¥
verify_connections() {
    log_step "éªŒè¯æ•°æ®åº“è¿æ¥..."
    
    # éªŒè¯PostgreSQLç³»ç»Ÿæ•°æ®åº“
    log_info "éªŒè¯PostgreSQLç³»ç»Ÿæ•°æ®åº“..."
    if docker exec postgresql-nl2sql-mvp1 psql -U nl2sql_user -d nl2sql -c "SELECT tablename FROM pg_tables WHERE tablename LIKE 'agent%';" 2>/dev/null | grep -q "agent"; then
        log_info "PostgreSQLç³»ç»Ÿæ•°æ®åº“è¿æ¥æˆåŠŸ âœ“"
    else
        log_warn "PostgreSQLç³»ç»Ÿæ•°æ®åº“è¿æ¥å¤±è´¥"
    fi
    
    # éªŒè¯Oracleä¸šåŠ¡æ•°æ®åº“
    log_info "éªŒè¯Oracleä¸šåŠ¡æ•°æ®åº“..."
    if docker exec oracle-nl2sql-mvp1 sqlplus -s nl2sql_user/nl2sql_pass@//localhost:1521/XE <<< "SELECT 'Oracle Connected' FROM DUAL; EXIT;" 2>/dev/null | grep -q "Oracle Connected"; then
        log_info "Oracleä¸šåŠ¡æ•°æ®åº“è¿æ¥æˆåŠŸ âœ“"
    else
        log_warn "Oracleä¸šåŠ¡æ•°æ®åº“è¿æ¥å¤±è´¥"
    fi
    
    # éªŒè¯PostgreSQLå‘é‡æ•°æ®åº“
    log_info "éªŒè¯PostgreSQLå‘é‡æ•°æ®åº“..."
    if docker exec postgresql-nl2sql-mvp1 psql -U nl2sql_user -d nl2sql -c "SELECT 'PostgreSQL Connected';" 2>/dev/null | grep -q "PostgreSQL Connected"; then
        log_info "PostgreSQLå‘é‡æ•°æ®åº“è¿æ¥æˆåŠŸ âœ“"
    else
        log_warn "PostgreSQLå‘é‡æ•°æ®åº“è¿æ¥å¤±è´¥"
    fi
}

# æ˜¾ç¤ºè¿æ¥ä¿¡æ¯
show_connection_info() {
    log_step "æ•°æ®åº“è¿æ¥ä¿¡æ¯"
    
    echo ""
    echo "ğŸ“‹ åˆ†ç¦»æ•°æ®åº“è¿æ¥ä¿¡æ¯ï¼š"
    echo "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
    echo "â”‚ ç³»ç»Ÿæ•°æ®åº“ (PostgreSQL + pgvector)                        â”‚"
    echo "â”‚   Host: localhost:5432                                      â”‚"
    echo "â”‚   Database: nl2sql                                          â”‚"
    echo "â”‚   Tables: agent, agent_datasource, agent_knowledge,        â”‚"
    echo "â”‚           agent_preset_question, business_knowledge,        â”‚"
    echo "â”‚           datasource, semantic_model                        â”‚"
    echo "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤"
    echo "â”‚ ä¸šåŠ¡æ•°æ®åº“ (Oracle)                                        â”‚"
    echo "â”‚   Host: localhost:1521                                      â”‚"
    echo "â”‚   Database: XE                                              â”‚"
    echo "â”‚   Tables: ACTV_DATA, B_UT_PROD, B_UT_PROD_OFER_CHANL,     â”‚"
    echo "â”‚           B_UT_PROD_CHANL_ATTR, BATCH_JOB,                 â”‚"
    echo "â”‚           BATCH_JOB_INSTANCE, CACHE_MAP, CUSTOMER,         â”‚"
    echo "â”‚           O_UT_PROD_CAT, STG_FUNDS_CSV                     â”‚"
    echo "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤"
    echo "â”‚ å‘é‡å­˜å‚¨ (PostgreSQL + pgvector - åŒç³»ç»Ÿæ•°æ®åº“)           â”‚"
    echo "â”‚   Host: localhost:5432                                      â”‚"
    echo "â”‚   Database: nl2sql                                          â”‚"
    echo "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤"
    echo "â”‚ ç¼“å­˜æ•°æ®åº“ (Qdrant)                                        â”‚"
    echo "â”‚   Host: localhost:6333                                      â”‚"
    echo "â”‚   Collection: nl2sql_query_cache                            â”‚"
    echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
    echo ""
}

# ä¸»å‡½æ•°
main() {
    echo "ğŸš€ Spring AI Alibaba NL2SQL åˆ†ç¦»æ•°æ®åº“å¯åŠ¨è„šæœ¬"
    echo "================================================"
    echo ""
    
    check_docker
    create_directories
    create_system_db_init
    create_business_db_init
    update_docker_compose
    start_databases
    wait_for_services
    verify_connections
    show_connection_info
    
    echo ""
    log_info "âœ… åˆ†ç¦»æ•°æ®åº“ç¯å¢ƒå¯åŠ¨å®Œæˆï¼"
    echo ""
    echo "ğŸ“ ä¸‹ä¸€æ­¥æ“ä½œï¼š"
    echo "  1. æ›´æ–° application-separated-db.yml é…ç½®æ–‡ä»¶"
    echo "  2. å¯åŠ¨ Spring Boot åº”ç”¨: mvn spring-boot:run -Dspring.profiles.active=separated-db"
    echo "  3. è®¿é—®ç®¡ç†ç•Œé¢éªŒè¯é…ç½®"
    echo ""
}

# æ‰§è¡Œä¸»å‡½æ•°
main "$@"
